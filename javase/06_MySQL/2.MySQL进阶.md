# MySQL进阶

## 一、多表查询

### 1. 简介

​	同时从多张表中查询数据，一般来说多张表之间都会存在某种关系

### 2. 基本用法

#### 2.1 语法	

```sql
select *|列名1 别名1,列名2 别名2... 
from 表名1 别名1,表名2 别名2
where 条件
order by 排序列1 asc|desc,排序列2 asc|desc
```

​	例：将emp表和dept表进行多表查询（笛卡尔积）

​	例：通过将两张表的关联字段进行比较，去掉笛卡尔积，多表查询时一般都会存在某种关系

​	例：为表起别名，简化操作

#### 2.2 示例

​	例：查询雇员编号、雇员姓名、工资、所在部门名称及位置（等值连接）

```sql
select e.deptno,e.ename,e.sal,d.dname,d.loc from emp e,dept d where e.deptno=d.deptno;
```



​	例：查询雇员姓名、雇员工资、领导姓名、领导工资（自身连接）

```sql
select form emp e, emp m where 
```



​	例：查询雇员姓名、雇员工资、部门名称、领导姓名、领导工资

​	例：查询雇员姓名、雇员工资、部门名称、工资所在等级（非等值连接） 

​	例：查询雇员姓名、雇员工资、部门名称、雇员工资等级、领导姓名、领导工资、领导工资等级

###  3. SQL99标准

####  3.1 简介 

​	SQL99标准，也称为SQL1999标准，是1999年制定的标准

​	分类：内连接、外连接

#### 3.2 内连接

​	使用inner join...on

​	语法：

```sql
select *|列名1 别名1,列名2 别名2... 
from 表名1 别名1 inner join 表名2 别名2 on 多表间的关联关系 
where 条件
order by 排序列1 asc|desc,排序列2 asc|desc;
```

​	例：查询雇员编号、雇员姓名、工资、部门名称

​	例：查询工资大于1500的雇员姓名、工资、所在部门名称、领导姓名

#### 3.3 外连接

​	分类：

- 左外连接 left outer join...on，也称为左连接 left join...on

  以左边的表作为主表，无论如何都会显示主表中的所有数据

- 右外连接 right outer join...on，也称为右连接 right join...on

  以右边的表作为主表，无论如何都会显示主表中的所有数据

​    语法：

```sql
select *|列名1 别名1,列名2 别名2... 
from 表名1 别名1 left outer join 表名2 别名2 on 多表间的关联关系 
where 条件
order by 排序列1 asc|desc,排序列2 asc|desc;
```

​	例：查询雇员姓名、工资、领导姓名、领导工资（有的雇员没有领导）

​	例：查询部门编号、部门名称、部门位置、部门中的雇员姓名、工资

## 二、聚合函数和分组统计

### 1. 聚合函数

​	聚合函数，也称为统计函数

​	常用的聚合函数：

- count() 总数量
- max() 最大值
- min() 最小值
- sum() 总和
- avg() 平均数

​    例：查询部门30的总人数

​	例：查询部门30的最高工资、最低工资、平均工资

​    注：使用聚合函数时不要查询无关的列，没意义

### 2. 分组统计

#### 2.1 语法

```sql
select *|列名1 别名1,列名2 别名2... 
from 表名1 别名1 left outer join 表名2 别名2 on 多表间的关联关系 
where 分组前的条件
group by 分组列
having 分组后的条件
order by 排序列1 asc|desc,排序列2 asc|desc
```

#### 2.2 示例

​	例：查询每个部门的平均工资

​	例：查询每个部门的名称、位置、平均工资

​    例：查询部门的名称及每个部门的员工数量（使用外连接）

​	例：查询平均工资大于2000的部门的编号和平均工资

​	例：查询出非销售人员的职位名称以及从事同一个工作的雇员的月工资总和，并且要满足月工资总和大于5000，查询的结果按月工资总和的升序排列

## 三、子查询

### 1. 简介

​	一个查询中嵌套着另一个查询，称为子查询

- 子查询必须放在小括号()中
 - 子查询可以出现在任意位置，如select、from、where、having等位置

### 2. 基本用法

#### 2.1 语法

```sql
select (子查询)
from (子查询) 别名
where (子查询) 
group by 
having (子查询)
```

#### 2.2 示例

​	例：查询工资比7566高的雇员信息

​	例：查询工资比部门20员工的工资高的雇员信息

​	例：查询雇员编号、姓名、部门名称（分别使用多表连接和子查询实现）



​	总结：

- 子查询一般作为条件，适合于操作单表的数据，灵活、方便
- 多表连接查询一般适合于查看多表的数据

### 3. 子查询分类

​	可以分为三类：

- 单行单列子查询

  返回`单行单列`，使用频率最高

- 多行单列子查询

  返回`多行单列`

- 多列子查询

  返回`多列`

#### 3.1 单行单列子查询

​	例：查询工资比7654高，同时又与7900从事相同工作的雇员信息

​	例：查询工资最低的雇员的姓名、工作、工资

​	例：查询工资高于公司平均工资的雇员信息

​	例：查询每个部门的编号和最低工资，要求最低工资大于等于部门30的最低工资

​	例：查询部门的名称、部门的员工数、部门的平均工资、部门的最低收入雇员的姓名

#### 3.2 多行单列子查询

​	对于多行单列子查询，可以使用以下三种操作符号：

- in

  例：查询领导工资大于等于3000的雇员信息

  例：查询工资与部门20中任意一个员工相同的雇员

- any

  三种用法：

  ```text
  =any : 与任意一个相同，此时与in操作符功能一样
  >any : 只要比里面最小的值大即可
  <any : 只要比里面最大的值小即可
  ```

  例：查询工资与部门20中任意一个员工相同的雇员

  例：查询工资高于部门20中任意一个员工的雇员

  例：查询工资低于部门20中任意一个员工的雇员

- all

  两种用法：

  ```text
  >all : 比里面最大的值要大
  <all : 比里面最小的值要小
  ```

  例：查询工资高于部门20中所有员工的雇员
  
  例：查询工资低于部门20中所有员工的雇员

#### 3.3 多列子查询

​	多列子查询一般出现在from子句中，作为查询结果集

​	例：在所有从事销售工作的雇员中找出工资大于1500的员工

## 四、分页查询

### 1. limit关键字

​	用来限制查询返回的记录数

​	语法：

```sql
select *|列名1 别名1,列名2 别名2... 
from 表名1 别名1 left outer join 表名2 别名2 on 多表间的关联关系 
where 分组前的条件
group by 分组列
having 分组后的条件
order by 排序列1 asc|desc,排序列2 asc|desc
limit [参数1,]参数2
```

​	可接受一个或两个参数：

- 参数1用来指定起始行的索引，索引从0开始，即第一行的索引为0
- 参数2用来指定返回的记录数量

​    例：查询工资的前3名

```sql
select * form emp order by sal desc limit 0,3; 
```



​	例：查询工资最低的用户

```sql
select *from emp order by sal asc limit 1;
```



​	例：查询工资大于1000的第4-8个用户

```sql
select *from where sal>1000 limit 3,5;
```



### 2. 分页

​	例：每页显示4条(pageSize每页大小)，显示第3页的内容(pageIndex页码)

```sql
select * from emp limit (pageIndex-1)*pageSize,pageSize  -- 计算
select * from emp limit (3-1)*4,4; -- 不能直接执行
select * from emp limit 8,4; 
```

​	注：在MySQL中limit后面的参数不能包含任何运算符，实际开发中都是在编程语言中进行计算，然后将结果发送到数据库中

## 五、常用函数

### 1. 字符串函数

​	concat(s1,s2,s3,.....) 拼接字符串

​	lower(s) 将字符串变成小写

​	upper(s) 将字符串变成大写

​	length(s) 获取字符串的长度

​	reverse(s) 将字符串反转

​	trim(s) 去除字符串两侧的空格

​	repeat(s,n) 将字符串s重复n次后返回

​	replace(s,s1,s2) 将字符串s中的s1替换为s2

​	substr(s,i,len) 从第i个位置开始对字符串s进行截取，截取len个字符

​	lpad(s,len,s1) 在字符串s的左侧使用s1进行填充，直至长度达为len

​	rpad(s,len,s1) 在字符串s的右侧使用s1进行填充，直至长度达为len

​	password(s) 对字符串s进行加密，一般用于用户注册时对密码进行加密处理

**注：dual表是MySQL提供的一张虚拟表，主要是为了满足select..from...语法习惯，一般测试时使用，无实际意义**


### 2. 数值函数

​	ceil(n) 返回大于n的最小整数

​	floor(n) 返回小于n的最大整数

​	round(n,y) 将n保留y位小数，四舍五入

​	truncate(n,y) 将n保留y位小数，不四舍五入

​	rand() 返回 [0,1) 之间的随机小数

### 3. 日期和时间函数

​	now() 返回当前日期时间

​	curdate() 返回当前日期

​	curtime() 返回当前时间

​	year(date) 返回日期中的年

​	month(date) 返回日期中的月

​	day(date) 返回日期中的日

​	timestampdiff(interval,datetime1,datetime2) 返回两个日期时间之间相隔的整数，单位由interval定义

- interval可取值：year、month、day、hour、minute、second

​    date_format(date,pattern) 格式化日期

- 格式化参数：

  %Y 表示四位数字的年份

  %m 表示两位数字的月份

  %d  表示两位数字的天数

  %H 表示两位数字的小时数，24小时制

  %i  表示两位数字的分钟数

  %s 表示两位数字的秒数 


### 4. 流程控制函数

​	if(f,v1,v2) 如果f为真，则返回v1，否则返回v2

​	ifnull(v1,v2) 如果v1不为null，则返回v1，否则返回v2

​	case when f1 then v1 when f2 then v2…else v end 如果f1为真，则返回v1；如果f2为真，则返回v2..否则返回v

### 5. 系统信息函数

​	database() 返回当前操作的数据库名 

​	user() 返回当前登陆的用户名 

​	version() 返回MySQL服务器的版本